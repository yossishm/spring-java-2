name: CVE Security Monitoring

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - 'pom.xml'
      - 'dotnet-spring-equivalent/SpringJavaEquivalent.csproj'
      - 'python-spring-equivalent/requirements.txt'
      - 'python-spring-equivalent/pyproject.toml'
      - 'Dockerfile*'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  spring-cve-scan:
    name: Spring Boot CVE Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Build Spring Boot application
      run: |
        mvn clean package -DskipTests
        
    - name: Build Spring Boot Docker image
      run: |
        docker build -f Dockerfile.alpine-distroless-v2 -t spring-app:latest .
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'spring-app:latest'
        format: 'sarif'
        output: 'spring-trivy-results.sarif'
        exit-code: '0'
        
    - name: Check SARIF file exists
      run: |
        if [ -f "spring-trivy-results.sarif" ]; then
          echo "âœ… SARIF file created successfully"
          ls -la spring-trivy-results.sarif
        else
          echo "âŒ SARIF file not found"
          ls -la
        fi
        
    - name: Display Trivy scan results
      run: |
        if [ -f "spring-trivy-results.sarif" ]; then
          echo "ðŸ“Š Trivy scan completed successfully"
          echo "Results saved to: spring-trivy-results.sarif"
        else
          echo "âš ï¸ No SARIF results file found"
        fi
        
    - name: Run Docker Scout
      run: |
        docker scout quickview spring-app:latest || true
        
    - name: Check for specific Spring CVEs
      run: |
        echo "ðŸ” Checking for known Spring CVEs..."
        SPRING_CVES=("CVE-2025-22234" "CVE-2025-22232" "CVE-2025-22228" "CVE-2023-34040" "CVE-2024-38829")
        for cve in "${SPRING_CVES[@]}"; do
          if docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --format json spring-app:latest | grep -q "$cve"; then
            echo "âš ï¸ FOUND: $cve in Spring application"
            echo "CVE_FOUND=true" >> $GITHUB_ENV
          else
            echo "âœ… Not found: $cve"
          fi
        done
        
    - name: Check for outdated Spring dependencies
      run: |
        mvn versions:display-dependency-updates || true
        
    - name: Create security report
      if: always()
      run: |
        echo "# Spring Boot Security Report - $(date)" > spring-security-report.md
        echo "## Scan Results" >> spring-security-report.md
        echo "- **Image**: spring-app:latest" >> spring-security-report.md
        echo "- **Base**: Alpine 3.23 with OpenJDK 21" >> spring-security-report.md
        echo "- **Scan Date**: $(date)" >> spring-security-report.md
        echo "- **Trivy Results**: spring-trivy-results.sarif" >> spring-security-report.md
        echo "" >> spring-security-report.md
        echo "## Recommendations" >> spring-security-report.md
        echo "1. Review all HIGH and CRITICAL vulnerabilities" >> spring-security-report.md
        echo "2. Update dependencies to latest secure versions" >> spring-security-report.md
        echo "3. Consider using Alpine-based images for better security" >> spring-security-report.md
        
    - name: Upload security report and scan results
      uses: actions/upload-artifact@v4
      with:
        name: spring-security-report
        path: |
          spring-security-report.md
          spring-trivy-results.sarif

  dotnet-cve-scan:
    name: .NET CVE Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Cache .NET dependencies
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/SpringJavaEquivalent.csproj') }}
        restore-keys: ${{ runner.os }}-nuget
        
    - name: Build .NET application
      run: |
        cd dotnet-spring-equivalent
        dotnet build
        
    - name: Build .NET Docker image
      run: |
        docker build -f dotnet-spring-equivalent/Dockerfile.alpine -t dotnet-app:latest dotnet-spring-equivalent/
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'dotnet-app:latest'
        format: 'sarif'
        output: 'dotnet-trivy-results.sarif'
        exit-code: '0'
        
    - name: Check SARIF file exists
      run: |
        if [ -f "dotnet-trivy-results.sarif" ]; then
          echo "âœ… SARIF file created successfully"
          ls -la dotnet-trivy-results.sarif
        else
          echo "âŒ SARIF file not found"
          ls -la
        fi
        
    - name: Display Trivy scan results
      run: |
        if [ -f "dotnet-trivy-results.sarif" ]; then
          echo "ðŸ“Š Trivy scan completed successfully"
          echo "Results saved to: dotnet-trivy-results.sarif"
        else
          echo "âš ï¸ No SARIF results file found"
        fi
        
    - name: Run Docker Scout
      run: |
        docker scout quickview dotnet-app:latest || true
        
    - name: Check for specific .NET CVEs
      run: |
        echo "ðŸ” Checking for known .NET CVEs..."
        DOTNET_CVES=("CVE-2018-8540" "CVE-2023-29337" "CVE-2023-33128" "CVE-2023-33170")
        for cve in "${DOTNET_CVES[@]}"; do
          if docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --format json dotnet-app:latest | grep -q "$cve"; then
            echo "âš ï¸ FOUND: $cve in .NET application"
            echo "CVE_FOUND=true" >> $GITHUB_ENV
          else
            echo "âœ… Not found: $cve"
          fi
        done
        
    - name: Check for outdated .NET dependencies
      run: |
        cd dotnet-spring-equivalent
        dotnet list package --outdated || true
        
    - name: Create security report
      if: always()
      run: |
        echo "# .NET Security Report - $(date)" > dotnet-security-report.md
        echo "## Scan Results" >> dotnet-security-report.md
        echo "- **Image**: dotnet-app:latest" >> dotnet-security-report.md
        echo "- **Base**: Alpine-based .NET 9.0" >> dotnet-security-report.md
        echo "- **Scan Date**: $(date)" >> dotnet-security-report.md
        echo "- **Trivy Results**: dotnet-trivy-results.sarif" >> dotnet-security-report.md
        echo "" >> dotnet-security-report.md
        echo "## Recommendations" >> dotnet-security-report.md
        echo "1. Review all HIGH and CRITICAL vulnerabilities" >> dotnet-security-report.md
        echo "2. Update dependencies to latest secure versions" >> dotnet-security-report.md
        echo "3. Consider using Alpine-based images for better security" >> dotnet-security-report.md
        
    - name: Upload security report and scan results
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-security-report
        path: |
          dotnet-security-report.md
          dotnet-trivy-results.sarif

  python-cve-scan:
    name: Python CVE Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'python-spring-equivalent/requirements.txt'
        
    - name: Install Python dependencies
      run: |
        cd python-spring-equivalent
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Run Safety check
      run: |
        cd python-spring-equivalent
        pip install safety
        safety check --json --output safety-results.json || true
        echo "âœ… Safety check completed"
        
    - name: Run Bandit security scan
      run: |
        cd python-spring-equivalent
        pip install bandit[toml]
        bandit -r python_spring_equivalent -f json -o bandit-results.json || true
        echo "âœ… Bandit scan completed"
        
    - name: Build Python Docker image
      run: |
        docker build -f python-spring-equivalent/Dockerfile.k8s -t python-app:latest python-spring-equivalent/
        
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'python-app:latest'
        format: 'sarif'
        output: 'python-trivy-results.sarif'
        exit-code: '0'
        
    - name: Check SARIF file exists
      run: |
        if [ -f "python-trivy-results.sarif" ]; then
          echo "âœ… SARIF file created successfully"
          ls -la python-trivy-results.sarif
        else
          echo "âŒ SARIF file not found"
          ls -la
        fi
        
    - name: Display Trivy scan results
      run: |
        if [ -f "python-trivy-results.sarif" ]; then
          echo "ðŸ“Š Trivy scan completed successfully"
          echo "Results saved to: python-trivy-results.sarif"
        else
          echo "âš ï¸ No SARIF results file found"
        fi
        
    - name: Run Docker Scout
      run: |
        docker scout quickview python-app:latest || true
        
    - name: Check for specific Python CVEs
      run: |
        echo "ðŸ” Checking for known Python CVEs..."
        PYTHON_CVES=("CVE-2024-33663" "CVE-2024-33664" "CVE-2025-62727" "CVE-2025-54121" "CVE-2024-23342")
        for cve in "${PYTHON_CVES[@]}"; do
          if docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy image --format json python-app:latest | grep -q "$cve"; then
            echo "âš ï¸ FOUND: $cve in Python application"
            echo "CVE_FOUND=true" >> $GITHUB_ENV
          else
            echo "âœ… Not found: $cve"
          fi
        done
        
    - name: Check for outdated Python dependencies
      run: |
        cd python-spring-equivalent
        pip list --outdated || true
        
    - name: Create security report
      if: always()
      run: |
        echo "# Python Security Report - $(date)" > python-security-report.md
        echo "## Scan Results" >> python-security-report.md
        echo "- **Image**: python-app:latest" >> python-security-report.md
        echo "- **Base**: Python 3.11.9-slim" >> python-security-report.md
        echo "- **Scan Date**: $(date)" >> python-security-report.md
        echo "- **Trivy Results**: python-trivy-results.sarif" >> python-security-report.md
        echo "- **Safety Results**: python-spring-equivalent/safety-results.json" >> python-security-report.md
        echo "- **Bandit Results**: python-spring-equivalent/bandit-results.json" >> python-security-report.md
        echo "" >> python-security-report.md
        echo "## Recommendations" >> python-security-report.md
        echo "1. Review all HIGH and CRITICAL vulnerabilities" >> python-security-report.md
        echo "2. Update dependencies to latest secure versions" >> python-security-report.md
        echo "3. Review Bandit findings and address security issues" >> python-security-report.md
        echo "4. Consider using Alpine-based images for better security" >> python-security-report.md
        
    - name: Upload security report and scan results
      uses: actions/upload-artifact@v4
      with:
        name: python-security-report
        path: |
          python-security-report.md
          python-trivy-results.sarif
          python-spring-equivalent/safety-results.json
          python-spring-equivalent/bandit-results.json

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [spring-cve-scan, dotnet-cve-scan, python-cve-scan]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download security reports
      uses: actions/download-artifact@v4
      with:
        path: security-reports
        
    - name: Create combined security report
      run: |
        echo "# Combined Security Report - $(date)" > combined-security-report.md
        echo "" >> combined-security-report.md
        echo "## Spring Boot Application" >> combined-security-report.md
        if [ -f "security-reports/spring-security-report/spring-security-report.md" ]; then
          cat security-reports/spring-security-report/spring-security-report.md >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md
        echo "## .NET Application" >> combined-security-report.md
        if [ -f "security-reports/dotnet-security-report/dotnet-security-report.md" ]; then
          cat security-reports/dotnet-security-report/dotnet-security-report.md >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md
        echo "## Python Application" >> combined-security-report.md
        if [ -f "security-reports/python-security-report/python-security-report.md" ]; then
          cat security-reports/python-security-report/python-security-report.md >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md
        echo "## CVE Security Monitoring" >> combined-security-report.md
        echo "" >> combined-security-report.md

        summarize_cves() {
          local sarif_file="$1"
          jq -r '
            [
              .runs[].results[]?
              | select(.ruleId != null)
              | "- " + .ruleId
                + " (" + ((.properties."security-severity" // .level // "UNKNOWN") | ascii_upcase) + ")"
                + ": "
                + ((.message.text // "No description provided") | gsub("\n"; " "))
            ]
            | unique
            | .[]
          ' "$sarif_file"
        }

        SPRING_SARIF="security-reports/spring-security-report/spring-trivy-results.sarif"
        echo "### Spring Boot Application" >> combined-security-report.md
        if [ -f "$SPRING_SARIF" ]; then
          SPRING_CVES=$(summarize_cves "$SPRING_SARIF")
          if [ -n "$SPRING_CVES" ]; then
            printf '%s\n' "$SPRING_CVES" >> combined-security-report.md
          else
            echo "- No CVEs detected in latest scan" >> combined-security-report.md
          fi
        else
          echo "- No scan results available" >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md

        DOTNET_SARIF="security-reports/dotnet-security-report/dotnet-trivy-results.sarif"
        echo "### .NET Application" >> combined-security-report.md
        if [ -f "$DOTNET_SARIF" ]; then
          DOTNET_CVES=$(summarize_cves "$DOTNET_SARIF")
          if [ -n "$DOTNET_CVES" ]; then
            printf '%s\n' "$DOTNET_CVES" >> combined-security-report.md
          else
            echo "- No CVEs detected in latest scan" >> combined-security-report.md
          fi
        else
          echo "- No scan results available" >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md

        PYTHON_SARIF="security-reports/python-security-report/python-trivy-results.sarif"
        echo "### Python Application" >> combined-security-report.md
        if [ -f "$PYTHON_SARIF" ]; then
          PYTHON_CVES=$(summarize_cves "$PYTHON_SARIF")
          if [ -n "$PYTHON_CVES" ]; then
            printf '%s\n' "$PYTHON_CVES" >> combined-security-report.md
          else
            echo "- No CVEs detected in latest scan" >> combined-security-report.md
          fi
        else
          echo "- No scan results available" >> combined-security-report.md
        fi
        echo "" >> combined-security-report.md
        echo "## Next Steps" >> combined-security-report.md
        echo "1. Review all security reports" >> combined-security-report.md
        echo "2. Address any HIGH or CRITICAL vulnerabilities" >> combined-security-report.md
        echo "3. Update dependencies as needed" >> combined-security-report.md
        echo "4. Consider implementing additional security measures" >> combined-security-report.md
        
    - name: Upload combined security report
      uses: actions/upload-artifact@v4
      with:
        name: combined-security-report
        path: combined-security-report.md
        
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('combined-security-report.md')) {
            const report = fs.readFileSync('combined-security-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ”’ Security Scan Results\n\n${report}`
            });
          }
