# CVE Monitoring Workflow - Fail on Fixable CVEs Only

## Problem

The CVE monitoring workflow was configured with `exit-code: '0'` for all Trivy scans, which meant **the build never failed**, even when HIGH or CRITICAL CVEs were detected. This included CVEs that have no available fixes (like CVE-2024-23342 for `ecdsa` package).

## Solution

Updated the workflow to:
1. **Generate full SARIF reports** (for all CVEs, including unfixed ones) - for reporting and monitoring
2. **Fail builds only on fixable HIGH/CRITICAL CVEs** - using `ignore-unfixed: true` flag
3. **Skip failure check on scheduled runs** - scheduled scans should report but not block

## Changes Made

### For Each Application (Spring Boot, .NET, Python)

**Before:**
```yaml
- name: Run Trivy vulnerability scanner
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'app:latest'
    format: 'sarif'
    output: 'results.sarif'
    exit-code: '0'  # Never fails
```

**After:**
```yaml
- name: Run Trivy vulnerability scanner (Full Report)
  uses: aquasecurity/trivy-action@master
  with:
    image-ref: 'app:latest'
    format: 'sarif'
    output: 'results.sarif'
    exit-code: '0'  # Always generates report

- name: Check for fixable HIGH/CRITICAL CVEs
  uses: aquasecurity/trivy-action@master
  if: github.event_name != 'schedule'  # Don't fail on scheduled runs
  with:
    image-ref: 'app:latest'
    format: 'table'
    exit-code: '1'  # Fails if fixable CVEs found
    severity: 'HIGH,CRITICAL'
    ignore-unfixed: true  # Only fail if fixes are available
```

## How It Works

1. **First Scan (Full Report):**
   - Generates complete SARIF report with ALL CVEs
   - Includes CVEs with and without fixes
   - Always succeeds (`exit-code: '0'`)
   - Used for reporting and GitHub Security tab

2. **Second Scan (Fail Check):**
   - Only runs on push/PR events (not scheduled runs)
   - Uses `ignore-unfixed: true` to skip CVEs without fixes
   - Only checks HIGH and CRITICAL severity
   - Fails the build (`exit-code: '1'`) if any fixable HIGH/CRITICAL CVEs are found

## Behavior Examples

### Scenario 1: CVE with No Fix (e.g., CVE-2024-23342)
- ✅ Full report includes the CVE
- ✅ Build **does NOT fail** (no fix available)
- ✅ CVE is reported in security dashboard
- ✅ Team can monitor for future fixes

### Scenario 2: CVE with Available Fix
- ✅ Full report includes the CVE
- ❌ Build **FAILS** (fix is available, should be applied)
- ✅ Developer must update dependency to fix
- ✅ Prevents deploying vulnerable code

### Scenario 3: Scheduled Run
- ✅ Full report generated
- ✅ Build **does NOT fail** (scheduled runs are informational)
- ✅ CVEs are reported for monitoring
- ✅ Team can review and plan fixes

## Benefits

1. **Prevents deploying fixable vulnerabilities** - Build fails when fixes are available
2. **Doesn't block on unfixable CVEs** - Won't fail builds for CVEs with no available fixes
3. **Maintains full visibility** - All CVEs still reported in SARIF files
4. **Scheduled runs remain informational** - Daily scans don't break the build
5. **Actionable failures** - Only fails when there's something that can be fixed

## Current Status

With the current CVE-2024-23342 (`ecdsa` package):
- ✅ **Build will NOT fail** (no fix available)
- ✅ **CVE is still reported** in security dashboard
- ✅ **Team can monitor** for future fixes
- ✅ **When fix becomes available**, build will start failing until fixed

## Testing

To test this configuration:

1. **Test with fixable CVE:**
   - Temporarily downgrade a dependency with a known fix
   - Push changes - build should fail

2. **Test with unfixable CVE:**
   - Current `ecdsa` CVE-2024-23342
   - Push changes - build should pass

3. **Test scheduled run:**
   - Wait for scheduled run or trigger manually
   - Should complete successfully regardless of CVEs

## Related Files

- `.github/workflows/cve-monitoring.yml` - Updated workflow file
- `SECURITY-REPORT-ANALYSIS-7.md` - Analysis of current security report

---

**Updated:** November 15, 2025  
**Status:** ✅ Implemented

