# Distroless .NET image using Chainguard's distroless .NET runtime
FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build
WORKDIR /src

# Copy project file and restore dependencies
COPY ["SpringJavaEquivalent.csproj", "."]
RUN dotnet restore "SpringJavaEquivalent.csproj"

# Copy source code
COPY ["Controllers/", "Controllers/"]
COPY ["Services/", "Services/"]
COPY ["Authorization/", "Authorization/"]
COPY ["Program.cs", "."]
COPY ["appsettings.json", "."]
COPY ["appsettings.Development.json", "."]

# Build and publish the application
WORKDIR "/src"
RUN dotnet publish "SpringJavaEquivalent.csproj" \
    -c Release \
    -o /app/publish \
    --self-contained false \
    --no-restore

# Use Chainguard's distroless .NET runtime (minimal, secure, no CVEs)
FROM cgr.dev/chainguard/dotnet-runtime:latest AS final
WORKDIR /app

# Copy the published application
COPY --from=build /app/publish .

# The distroless image already runs as non-root user
EXPOSE 5000

# Entry point
ENTRYPOINT ["dotnet", "SpringJavaEquivalent.dll"]
