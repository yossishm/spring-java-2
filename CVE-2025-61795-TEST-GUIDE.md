# CVE-2025-61795 Test Guide

## Overview

CVE-2025-61795 is an "Improper Resource Shutdown or Release" vulnerability in Apache Tomcat that affects versions:
- 11.0.0-M1 through 11.0.11
- 10.1.0-M1 through 10.1.46 â† **Your current version**
- 9.0.0.M1 through 9.0.109
- 8.5.0 through 8.5.100

## Vulnerability Details

When multipart uploads fail (e.g., due to size limits), Tomcat creates temporary files on disk but doesn't immediately delete them. These files are left for garbage collection, which can lead to:
- Disk space exhaustion
- Denial of Service (DoS)
- Resource accumulation under high load

## Test Components

### 1. Vulnerable Endpoint
- **File**: `src/main/java/hello/controller/FileUploadController.java`
- **Endpoint**: `POST /api/v1/files/upload`
- **Purpose**: Demonstrates the vulnerability with a 1KB file size limit

### 2. Test Cases
- **File**: `src/test/java/hello/CVE202561795Test.java`
- **Purpose**: Automated tests to verify the vulnerability

### 3. Exploitation Script
- **File**: `test-cve-2025-61795.sh`
- **Purpose**: Standalone script to demonstrate DoS attack

### 4. Configuration
- **File**: `src/main/resources/application-cve-test.properties`
- **Purpose**: Sets small file limits to trigger the vulnerability

## Running the Tests

### Prerequisites
1. Ensure your application is using Tomcat 10.1.46 (vulnerable version)
2. Have the application running on port 8080

### Method 1: Automated Test Suite
```bash
# Run with CVE test profile
mvn test -Dspring.profiles.active=cve-test -Dtest=CVE202561795Test

# Or run all tests
mvn test
```

### Method 2: Manual Exploitation Script
```bash
# Make script executable (if not already)
chmod +x test-cve-2025-61795.sh

# Run the exploitation test
./test-cve-2025-61795.sh
```

### Method 3: Manual Testing with curl
```bash
# Create a large file (2KB to exceed 1KB limit)
dd if=/dev/zero of=/tmp/large-file.txt bs=1 count=2048

# Send request that triggers the vulnerability
curl -X POST -F "file=@/tmp/large-file.txt" http://localhost:8080/api/v1/files/upload

# Check system info
curl http://localhost:8080/api/v1/files/system-info | jq
```

## Expected Results

### Vulnerable System (Tomcat 10.1.46)
- Requests with files > 1KB return HTTP 413 (Payload Too Large)
- Temporary files accumulate in `/tmp` directory
- Files are not immediately cleaned up
- System info shows increasing temp file count

### Patched System (Tomcat 10.1.47+)
- Requests with files > 1KB return HTTP 413 (Payload Too Large)
- Temporary files are properly cleaned up
- No accumulation of temp files
- System remains stable under load

## Monitoring the Vulnerability

### Check Temporary Files
```bash
# Count Tomcat temp files
find /tmp -name "tomcat*" -type f | wc -l

# List Tomcat temp files
find /tmp -name "tomcat*" -type f -ls

# Monitor temp file creation in real-time
watch -n 1 'find /tmp -name "tomcat*" -type f | wc -l'
```

### System Resource Monitoring
```bash
# Check disk usage
df -h /tmp

# Monitor memory usage
free -h

# Check application logs
tail -f logs/spring.log | grep -i tomcat
```

## Exploitation Scenarios

### 1. Single Request Test
- Upload a file slightly larger than the limit
- Verify temporary file creation
- Check if file is cleaned up

### 2. DoS Attack Simulation
- Send multiple concurrent requests with large files
- Monitor temporary file accumulation
- Verify resource exhaustion potential

### 3. Load Testing
- Use tools like Apache Bench or wrk
- Send sustained load with oversized files
- Monitor system stability

## Mitigation

### Immediate Fix
1. **Upgrade Tomcat**: Update to version 10.1.47+ or 11.0.12+
2. **Update Spring Boot**: Use a version that includes patched Tomcat
3. **Monitor**: Implement monitoring for temporary file accumulation

### Configuration Changes
```properties
# Increase file size limits if appropriate
spring.servlet.multipart.max-file-size=10MB
spring.servlet.multipart.max-request-size=10MB

# Add cleanup monitoring
management.endpoints.web.exposure.include=health,info,metrics
```

### Code Changes
```java
// Add proper error handling for multipart uploads
@ExceptionHandler(MaxUploadSizeExceededException.class)
public ResponseEntity<String> handleMaxUploadSizeExceeded(MaxUploadSizeExceededException ex) {
    // Ensure temporary files are cleaned up
    return ResponseEntity.status(HttpStatus.PAYLOAD_TOO_LARGE)
        .body("File too large");
}
```

## Security Implications

1. **DoS Potential**: Attackers can exhaust disk space
2. **Resource Exhaustion**: Temporary files accumulate faster than GC can clean
3. **System Instability**: Can cause application crashes under load
4. **Information Disclosure**: Temporary files may contain sensitive data

## References

- [CVE-2025-61795 NVD Entry](https://nvd.nist.gov/vuln/detail/CVE-2025-61795)
- [Apache Tomcat Security Advisory](https://tomcat.apache.org/security.html)
- [Spring Boot Security Updates](https://spring.io/security)

## Test Results Template

```
=== CVE-2025-61795 Test Results ===
Date: [DATE]
Tomcat Version: [VERSION]
Test Method: [AUTOMATED/MANUAL/SCRIPT]

Initial temp files: [COUNT]
Final temp files: [COUNT]
Temp files created: [COUNT]

Vulnerability Status: [CONFIRMED/NOT_FOUND]
Mitigation Required: [YES/NO]

Notes:
[ADDITIONAL_OBSERVATIONS]
```
