#!/bin/bash

# CVE-2025-61795 Demonstration Script
# This script demonstrates the vulnerability and shows how to test it

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== CVE-2025-61795 Demonstration ===${NC}"
echo ""
echo "CVE-2025-61795: Improper Resource Shutdown or Release in Apache Tomcat"
echo "Your current Tomcat version: 10.1.46 (VULNERABLE)"
echo ""

# Check if we're in the right directory
if [ ! -f "pom.xml" ]; then
    echo -e "${RED}‚ùå Please run this script from the project root directory${NC}"
    exit 1
fi

echo -e "${YELLOW}Step 1: Building the application...${NC}"
mvn clean compile -q

echo -e "${YELLOW}Step 2: Running the vulnerability test...${NC}"
echo "This will start the application and run tests to demonstrate CVE-2025-61795"
echo ""

# Run the test with CVE test profile
mvn test -Dspring.profiles.active=cve-test -Dtest=CVE202561795Test

echo ""
echo -e "${YELLOW}Step 3: Manual exploitation test...${NC}"
echo "You can also run the manual exploitation script:"
echo "  ./test-cve-2025-61795.sh"
echo ""

echo -e "${YELLOW}Step 4: Check your Tomcat version...${NC}"
mvn dependency:tree | grep -i tomcat

echo ""
echo -e "${BLUE}=== Summary ===${NC}"
echo "‚úÖ Test cases created to demonstrate CVE-2025-61795"
echo "‚úÖ Vulnerable endpoint: POST /api/v1/files/upload"
echo "‚úÖ Monitoring endpoint: GET /api/v1/files/system-info"
echo "‚úÖ Exploitation script: ./test-cve-2025-61795.sh"
echo ""
echo -e "${RED}‚ö†Ô∏è  Your Tomcat version (10.1.46) is vulnerable to CVE-2025-61795${NC}"
echo -e "${YELLOW}üîß To fix: Upgrade to Tomcat 10.1.47+ or Spring Boot with patched Tomcat${NC}"
echo ""
echo "For more details, see: CVE-2025-61795-TEST-GUIDE.md"
