# Multi-stage build with OTEL Java agent for proper OpenTelemetry support
# Based on alpine-distroless-offline but with OTEL agent

# Stage 1: Builder with full JDK
FROM eclipse-temurin:21.0.8_9-jdk-alpine-3.22 AS builder
WORKDIR /build

# Download OTEL Java agent
RUN wget -O /build/opentelemetry-javaagent.jar https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar

# Copy application JAR
COPY target/gs-spring-boot-docker-0.2.0.jar /build/app.jar

# Stage 2: Minimal Alpine runtime with OTEL agent
FROM alpine:3.22.1 AS final

# Copy Java runtime from builder stage
COPY --from=builder /opt/java/openjdk /opt/java/openjdk

# Copy OTEL agent
COPY --from=builder /build/opentelemetry-javaagent.jar /app/opentelemetry-javaagent.jar

# Set working directory
WORKDIR /app

# Copy the JAR from builder stage
COPY --from=builder /build/app.jar /app/app.jar

# Switch to nobody user
USER nobody:nobody

# Run application with OTEL Java agent
ENTRYPOINT ["/opt/java/openjdk/bin/java", "-javaagent:/app/opentelemetry-javaagent.jar", "-jar", "/app/app.jar"]
